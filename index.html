<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰ºæœ¯å­—ä½“è½¬æ¢å™¨ â€” æ‹¼å›¾æ¨¡å¼</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Dancing+Script&family=Pacifico&family=Great+Vibes&family=Shadows+Into+Light&family=Ma+Shan+Zheng&family=Zhi+Mang+Xing&family=ZCOOL+KuaiLe&family=ZCOOL+XiaoWei&display=swap');
        
        body {
            background-color: #f0f0f0;
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 24px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.08);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 18px;
        }

        .row {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .left, .right {
            background: #fff;
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }

        .left {
            flex: 1 1 360px;
        }

        .right {
            width: 520px;
            text-align: center;
        }

        label { display:block; margin-bottom:6px; color:#444; }
        input[type="text"], select, input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            margin-bottom: 12px;
        }

        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

        .control-full { grid-column: 1 / -1; }

        input[type="range"] { width: 100%; }

        button {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
        }

        button.secondary {
            background: #888;
        }

        canvas { background: #fff; border-radius:8px; max-width:100%; }

        .note { font-size: 13px; color: #666; margin-top:8px; }

        /* existing font showcase styles (kept) */
        .font-grid { margin-top:18px; display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; }
        .font-showcase { padding:12px; border:1px solid #eee; border-radius:6px; }
        .font-name { font-size:12px; color:#666; margin-bottom:8px; }
        .font-example { font-size:32px; text-align:center; min-height:48px; display:flex;align-items:center;justify-content:center; }

    </style>
    </head>
<body>
    <div class="container">
        <h1>ç”¨å°å­—æ‹¼å‡ºå¤§å­—ï¼ˆæ‹¼å›¾ / é©¬èµ›å…‹ï¼‰</h1>

        <div class="row">
            <div class="left">
                <div class="controls">
                    <div>
                        <label for="smallChar">å°å­—ç¬¦ï¼ˆç”¨äºæ‹¼å›¾ï¼‰</label>
                        <input id="smallChar" type="text" maxlength="1" value="ç…Š" placeholder="å°å­—ç¬¦">
                    </div>

                    <div>
                        <label for="tileMode">å°å­—ç±»å‹</label>
                        <select id="tileMode">
                            <option value="char">å­—ç¬¦</option>
                            <option value="emoji">è¡¨æƒ…</option>
                            <option value="image">å›¾ç‰‡ï¼ˆä¸Šä¼ ï¼‰</option>
                        </select>
                    </div>

                    <div>
                        <label for="bigChar">å¤§å­—ç¬¦ï¼ˆç›®æ ‡å½¢çŠ¶ï¼‰</label>
                        <input id="bigChar" type="text" maxlength="1" value="æŒ¯" placeholder="ç›®æ ‡å¤§å­—">
                    </div>

                    <div>
                        <label for="gridSize">æ ¼å­å¤§å°ï¼ˆå­—ä½“å¤§å°ï¼‰ <span id="gridSizeVal">12</span>px</label>
                        <input id="gridSize" type="range" min="6" max="48" value="12">
                    </div>

                    <div>
                        <label for="threshold">å¯†åº¦é˜ˆå€¼ï¼ˆåƒç´ é˜ˆå€¼ï¼‰ <span id="thresholdVal">128</span></label>
                        <input id="threshold" type="range" min="0" max="255" value="128">
                    </div>

                    <div>
                        <label for="colorPicker">å°å­—é¢œè‰²</label>
                        <input id="colorPicker" type="color" value="#222222">
                    </div>

                    <div>
                        <label for="bgColor">èƒŒæ™¯é¢œè‰²</label>
                        <input id="bgColor" type="color" value="#ffffff">
                    </div>

                    <div class="control-full">
                        <label for="fontSelect">å°å­—å­—ä½“ï¼ˆé¢„è§ˆï¼‰</label>
                        <select id="fontSelect">
                            <option value="24px 'ZCOOL KuaiLe', sans-serif">ZCOOL KuaiLe</option>
                            <option value="24px 'Ma Shan Zheng', cursive">Ma Shan Zheng</option>
                            <option value="24px 'Zhi Mang Xing', cursive">Zhi Mang Xing</option>
                            <option value="24px 'ZCOOL XiaoWei', serif">ZCOOL XiaoWei</option>
                            <option value="24px Arial, sans-serif">ç³»ç»Ÿ Arial</option>
                        </select>
                    </div>

                    <div class="control-full" id="emojiBlock" style="display:none;">
                        <label>è¡¨æƒ…åŒ…åº“ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</label>
                        <div id="emojiGallery" style="display:flex;flex-wrap:wrap;gap:6px;">
                            <!-- å¸¸ç”¨è¡¨æƒ…ï¼ˆUnicodeï¼‰ -->
                            <button class="emoji-item" type="button">ğŸ˜€</button>
                            <button class="emoji-item" type="button">ğŸ˜</button>
                            <button class="emoji-item" type="button">ğŸ˜‚</button>
                            <button class="emoji-item" type="button">ğŸ˜</button>
                            <button class="emoji-item" type="button">ğŸ¤–</button>
                            <button class="emoji-item" type="button">ğŸ¶</button>
                            <button class="emoji-item" type="button">ğŸ±</button>
                            <button class="emoji-item" type="button">â¤ï¸</button>
                            <button class="emoji-item" type="button">ğŸŒŸ</button>
                            <button class="emoji-item" type="button">ğŸ‰</button>
                            <button class="emoji-item" type="button">ğŸ”¥</button>
                            <button class="emoji-item" type="button">ğŸµ</button>
                        </div>
                        <div style="margin-top:8px;">
                            <label for="uploadImg">ä¸Šä¼ å›¾ç‰‡ï¼ˆå¯é€‰ï¼‰</label>
                            <input id="uploadImg" type="file" accept="image/*">
                        </div>
                    </div>

                    <div class="control-full">
                        <label for="bigFontSelect">å¤§å­—å­—ä½“ï¼ˆç”¨äºç”»å½¢çŠ¶ï¼‰</label>
                        <select id="bigFontSelect">
                            <option value="serif">ç³»ç»Ÿ Serif</option>
                            <option value="'Ma Shan Zheng', cursive">Ma Shan Zheng</option>
                            <option value="'Zhi Mang Xing', cursive">Zhi Mang Xing</option>
                            <option value="'ZCOOL XiaoWei', serif">ZCOOL XiaoWei</option>
                            <option value="'ZCOOL KuaiLe', sans-serif">ZCOOL KuaiLe</option>
                            <option value="Arial, sans-serif">ç³»ç»Ÿ Arial</option>
                        </select>
                    </div>

                    <div style="grid-column:1/3; display:flex; gap:8px; justify-content:flex-end;">
                        <button id="generateBtn">ç”Ÿæˆæ‹¼å›¾</button>
                        <button id="downloadBtn" class="secondary">å¯¼å‡º PNG</button>
                    </div>
                </div>
                <p class="note">è¯´æ˜ï¼šè¾“å…¥ä¸¤ä¸ªå­—ç¬¦åç‚¹å‡»â€œç”Ÿæˆæ‹¼å›¾â€ã€‚å¯è°ƒèŠ‚æ ¼å­å¤§å°å’Œå¯†åº¦ä»¥è·å¾—ä¸åŒç»†èŠ‚æ•ˆæœã€‚</p>
            </div>

            <div class="right">
                <canvas id="mosaicCanvas" width="500" height="500" aria-label="æ‹¼å›¾é¢„è§ˆ"></canvas>
                <div style="margin-top:8px; display:flex; gap:8px; justify-content:center;">
                    <button id="fitBtn" class="secondary">é€‚åº”å®½åº¦</button>
                    <button id="clearBtn" class="secondary">æ¸…é™¤</button>
                </div>
            </div>
        </div>

        <div class="font-grid" style="margin-top:18px;">
            <div class="font-showcase">
                <div class="font-name">é©¬å–„é’Ÿæ¥·ä¹¦ä½“</div>
                <div class="font-example ma-shan-zheng" id="ex1"></div>
            </div>
            <div class="font-showcase">
                <div class="font-name">æ™ºå­Ÿè¡Œä¹¦ä½“</div>
                <div class="font-example zhi-mang-xing" id="ex2"></div>
            </div>
            <div class="font-showcase">
                <div class="font-name">å¿«ä¹ä½“</div>
                <div class="font-example zcool-kuaile" id="ex3"></div>
            </div>
            <div class="font-showcase">
                <div class="font-name">å°é­ä½“</div>
                <div class="font-example zcool-xiaowei" id="ex4"></div>
            </div>
        </div>
    </div>

    <script>
        // ç®€å•è¾“å…¥é™åˆ¶ä¸ç¤ºä¾‹æ›´æ–°
        const inputSmall = document.getElementById('smallChar');
        const inputBig = document.getElementById('bigChar');
        const examples = [document.getElementById('ex1'), document.getElementById('ex2'), document.getElementById('ex3'), document.getElementById('ex4')];

        function updateExamples() {
            const v = inputSmall.value || '';
            examples.forEach(el => el.textContent = v);
        }

        inputSmall.addEventListener('input', (e)=>{
            if (e.target.value.length>1) e.target.value = e.target.value.charAt(0);
            updateExamples();
        });

        inputBig.addEventListener('input', (e)=>{ if (e.target.value.length>1) e.target.value = e.target.value.charAt(0); });

        updateExamples();

        // é©¬èµ›å…‹ç”Ÿæˆé€»è¾‘
        const canvas = document.getElementById('mosaicCanvas');
        const ctx = canvas.getContext('2d');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const clearBtn = document.getElementById('clearBtn');
        const fitBtn = document.getElementById('fitBtn');

    const gridSizeInput = document.getElementById('gridSize');
        const gridSizeVal = document.getElementById('gridSizeVal');
        const thresholdInput = document.getElementById('threshold');
        const thresholdVal = document.getElementById('thresholdVal');
        const colorPicker = document.getElementById('colorPicker');
        const bgColor = document.getElementById('bgColor');
        const fontSelect = document.getElementById('fontSelect');
    const bigFontSelect = document.getElementById('bigFontSelect');
        const tileMode = document.getElementById('tileMode');
        const emojiBlock = document.getElementById('emojiBlock');
        const emojiGallery = document.getElementById('emojiGallery');
        const uploadImg = document.getElementById('uploadImg');

        let uploadedImage = null; // Image object
        let selectedEmoji = '';

        gridSizeInput.addEventListener('input', ()=>{ gridSizeVal.textContent = gridSizeInput.value; });
        thresholdInput.addEventListener('input', ()=>{ thresholdVal.textContent = thresholdInput.value; });

        tileMode.addEventListener('change', ()=>{
            const mode = tileMode.value;
            if (mode === 'emoji' || mode === 'image') {
                emojiBlock.style.display = 'block';
            } else {
                emojiBlock.style.display = 'none';
            }
        });

        // emoji gallery click
        emojiGallery.addEventListener('click', (e)=>{
            const btn = e.target.closest('.emoji-item');
            if (!btn) return;
            selectedEmoji = btn.textContent.trim();
            // reflect in smallChar input for preview
            inputSmall.value = selectedEmoji;
            updateExamples();
        });

        // file upload
        uploadImg.addEventListener('change', (e)=>{
            const file = e.target.files && e.target.files[0];
            if (!file) return;
            const url = URL.createObjectURL(file);
            const img = new Image();
            img.onload = ()=>{ uploadedImage = img; URL.revokeObjectURL(url); };
            img.src = url;
        });

        function generateMosaic() {
            const small = inputSmall.value || '';
            const big = inputBig.value || '';
            const grid = parseInt(gridSizeInput.value, 10) || 12;
            const threshold = parseInt(thresholdInput.value, 10) || 128;
            const color = colorPicker.value || '#222';
            const background = bgColor.value || '#fff';

            // æ¸…é™¤å¹¶å¡«å……èƒŒæ™¯
            ctx.fillStyle = background;
            ctx.fillRect(0,0,canvas.width,canvas.height);

            // å…ˆåœ¨ç¦»å± canvas ä¸Šç»˜åˆ¶å¤§å­—ç¬¦
            const off = document.createElement('canvas');
            off.width = canvas.width;
            off.height = canvas.height;
            const octx = off.getContext('2d');
            octx.clearRect(0,0,off.width,off.height);

            // é€‰æ‹©åˆé€‚çš„å­—ä½“å¤§å°ï¼Œä½¿å¤§å­—å æ»¡ç”»å¸ƒ
            const fontSize = Math.floor(off.height * 0.9);
            octx.fillStyle = '#000';
            octx.textAlign = 'center';
            octx.textBaseline = 'middle';
            // ä½¿ç”¨ç”¨æˆ·é€‰æ‹©çš„å¤§å­—å­—ä½“ï¼ˆä»…æ›¿æ¢å­—ä½“æ—éƒ¨åˆ†ï¼‰
            const bigFontFamily = bigFontSelect.value || 'serif';
            octx.font = `${fontSize}px ${bigFontFamily}`;
            octx.fillText(big, off.width/2, off.height/2);

            // è¯»å–åƒç´ æ•°æ®
            const img = octx.getImageData(0,0,off.width,off.height);
            const data = img.data;

            // å°å­—ç»˜åˆ¶æ ·å¼
            ctx.fillStyle = color;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';

            // è®¾ç½®å°å­—å­—ä½“ï¼ˆfontSelect ä¸­ä¿å­˜äº† font declaration çš„å‰ç¼€å¤§å°ï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›–å¤§å°ï¼‰
            function getSmallFont(size) {
                // fontSelect.value å½¢å¦‚ "24px 'ZCOOL KuaiLe', sans-serif"
                const base = fontSelect.value;
                // æŠŠå‰é¢çš„æ•°å­—æ›¿æ¢ä¸º size
                return base.replace(/^[0-9]+px/, size + 'px');
            }

            // éå†ç½‘æ ¼ï¼Œä¾æ®åƒç´ äº®åº¦å†³å®šæ˜¯å¦ç»˜åˆ¶å°å­—
            for (let y = 0; y < off.height; y += grid) {
                for (let x = 0; x < off.width; x += grid) {
                    const idx = (y * off.width + x) * 4;
                    const r = data[idx], g = data[idx+1], b = data[idx+2], a = data[idx+3];
                    // ä½¿ç”¨äº®åº¦æˆ– alpha åˆ¤æ–­ï¼šè¿™é‡Œç”¨å¹³å‡äº®åº¦
                    const lum = (r + g + b) / 3;
                    if (a > 128 && lum < (255 - threshold)) {
                        // draw tile at (x,y) based on mode
                        const mode = tileMode.value;
                        const cx = x + grid/2;
                        const cy = y + grid/2 + 1;
                        if (mode === 'char') {
                            ctx.font = getSmallFont(Math.floor(grid * 0.9));
                            ctx.fillText(small, cx, cy);
                        } else if (mode === 'emoji') {
                            // emoji as text
                            ctx.font = `${Math.floor(grid * 0.95)}px serif`;
                            const em = selectedEmoji || small;
                            ctx.fillText(em, cx, cy + Math.floor(grid*0.05));
                        } else if (mode === 'image' && uploadedImage) {
                            // draw uploaded image scaled to grid
                            try {
                                ctx.drawImage(uploadedImage, x, y, grid, grid);
                            } catch (err) {
                                // fallback to small char
                                ctx.font = getSmallFont(Math.floor(grid * 0.9));
                                ctx.fillText(small, cx, cy);
                            }
                        } else {
                            // fallback
                            ctx.font = getSmallFont(Math.floor(grid * 0.9));
                            ctx.fillText(small, cx, cy);
                        }
                    }
                }
            }
        }

        generateBtn.addEventListener('click', () => {
            generateMosaic();
        });

        clearBtn.addEventListener('click', ()=>{
            ctx.clearRect(0,0,canvas.width,canvas.height);
        });

        fitBtn.addEventListener('click', ()=>{
            // å°† canvas å®½åº¦è®¾ç½®ä¸ºå®¹å™¨å®½åº¦çš„æœ€å¤§å€¼ï¼ˆä¿ç•™æ–¹å½¢ï¼‰
            const right = document.querySelector('.right');
            const style = getComputedStyle(right);
            const w = Math.min(600, right.clientWidth - parseFloat(style.paddingLeft || 0) );
            canvas.width = w;
            canvas.height = w;
            generateMosaic();
        });

        downloadBtn.addEventListener('click', ()=>{
            const link = document.createElement('a');
            link.download = `mosaic_${(inputBig.value||'big')}_${Date.now()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        });

        // åˆå§‹ç»˜åˆ¶
        window.addEventListener('load', ()=>{
            // ensure canvas square and scale for devicePixelRatio
            const dpr = window.devicePixelRatio || 1;
            const size = 500;
            canvas.width = size * dpr;
            canvas.height = size * dpr;
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            ctx.setTransform(dpr,0,0,dpr,0,0);
            generateMosaic();
        });

    </script>
</body>
</html>